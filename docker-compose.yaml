version: '3.8'

services:
  # ===========================================
  # DATABASE SERVICES
  # ===========================================
  
  mysql:
    image: mysql:8.0
    container_name: schulolympiade_mysql
    restart: always
    ports:
      - "${SERVER_HOST}:${MYSQL_EXTERNAL_PORT:-3308}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
    networks:
      - olympiade_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql_backup:
    image: fradelg/mysql-cron-backup
    container_name: mysql_backup
    restart: always
    environment:
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASS: ${MYSQL_PASSWORD}
      MYSQL_DB: ${MYSQL_DATABASE}
      CRON_TIME: ${BACKUP_CRON:-*/10 * * * *}
      MAX_BACKUPS: ${MAX_BACKUPS:-10}
      TZ: ${TZ:-Europe/Berlin}
    volumes:
      - ./data/backups:/backup
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - olympiade_network

  # ===========================================
  # n8n AUTOMATION
  # ===========================================
  
  postgres:
    image: postgres:15
    container_name: n8n_postgres
    restart: always
    environment:
      POSTGRES_USER: ${N8N_POSTGRES_USER}
      POSTGRES_PASSWORD: ${N8N_POSTGRES_PASSWORD}
      POSTGRES_DB: ${N8N_POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - olympiade_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${N8N_POSTGRES_USER} -d ${N8N_POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n
    restart: always
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      WEBHOOK_URL: http://${SERVER_HOST}:${N8N_PORT:-5678}
      N8N_HOST: ${SERVER_HOST}
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: ${N8N_POSTGRES_DB}
      DB_POSTGRESDB_USER: ${N8N_POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${N8N_POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: public
      GENERIC_TIMEZONE: ${TZ:-Europe/Berlin}
      TZ: ${TZ:-Europe/Berlin}
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_BASIC_AUTH_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_BASIC_AUTH_PASSWORD}
      N8N_SECURE_COOKIE: false
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - olympiade_network

  # ===========================================
  # APPLICATION SERVICES
  # ===========================================
  
  dashboard:
    build:
      context: .
      dockerfile: services/dashboard/Dockerfile
    container_name: dashboard
    restart: always
    ports:
      - "${DASHBOARD_PORT:-3000}:3000"
    environment:
      PORT: 3000
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      SERVER_HOST: ${SERVER_HOST}
    volumes:
      - dashboard_logs:/app/logs
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - olympiade_network

  success-event:
    build:
      context: .
      dockerfile: services/success-event/Dockerfile
    container_name: success-event
    restart: always
    ports:
      - "${SUCCESS_EVENT_PORT:-3001}:3001"
    environment:
      PORT: 3001
    networks:
      - olympiade_network

  success-emoji:
    build:
      context: .
      dockerfile: services/success-emoji/Dockerfile
    container_name: success-emoji
    restart: always
    ports:
      - "${SUCCESS_EMOJI_PORT:-3002}:3002"
    environment:
      PORT: 3002
    networks:
      - olympiade_network

  edit-data:
    build:
      context: .
      dockerfile: services/edit-data/Dockerfile
    container_name: edit-data
    restart: always
    ports:
      - "${EDIT_DATA_PORT:-3003}:3003"
    environment:
      PORT: 3003
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - olympiade_network

  edit-emoji:
    build:
      context: .
      dockerfile: services/edit-emoji/Dockerfile
    container_name: edit-emoji
    restart: always
    ports:
      - "${EDIT_EMOJI_PORT:-3004}:3004"
    environment:
      PORT: 3004
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - olympiade_network

  ip-logging:
    build:
      context: .
      dockerfile: services/ip-logging/Dockerfile
    container_name: ip-logging
    restart: always
    ports:
      - "${IP_LOGGING_PORT:-3005}:3005"
    environment:
      PORT: 3005
      SERVER_HOST: ${SERVER_HOST}
      N8N_PORT: ${N8N_PORT:-5678}
      N8N_EVENT_WEBHOOK_ID: ${N8N_EVENT_WEBHOOK_ID}
    volumes:
      - ip_logs:/app/logs
    networks:
      - olympiade_network

  # ===========================================
  # INFRASTRUCTURE SERVICES
  # ===========================================
  
  nginx:
    image: nginx:stable
    container_name: nginx
    restart: always
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    environment:
      N8N_EMOJI_WEBHOOK_ID: ${N8N_EMOJI_WEBHOOK_ID}
    depends_on:
      - dashboard
      - edit-data
      - edit-emoji
      - ip-logging
      - n8n
    networks:
      - olympiade_network

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    restart: always
    ports:
      - "${PHPMYADMIN_PORT:-8080}:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - olympiade_network

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: cloudbeaver
    restart: unless-stopped
    ports:
      - "${CLOUDBEAVER_PORT:-8081}:8978"
    volumes:
      - cloudbeaver_data:/opt/cloudbeaver/workspace
    networks:
      - olympiade_network

# ===========================================
# VOLUMES
# ===========================================

volumes:
  mysql_data:
  postgres_data:
  n8n_data:
  cloudbeaver_data:
  dashboard_logs:
  ip_logs:

# ===========================================
# NETWORKS
# ===========================================

networks:
  olympiade_network:
    driver: bridge
