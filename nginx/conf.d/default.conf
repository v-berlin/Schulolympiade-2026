upstream dashboard {
    server dashboard:3000;
}

upstream success-event {
    server success-event:3001;
}

upstream success-emoji {
    server success-emoji:3002;
}

upstream edit-data {
    server edit-data:3003;
}

upstream ip-logging {
    server ip-logging:3005;
}

upstream n8n {
    server n8n:5678;
}

server {
    listen 80;
    server_name _;

    # Dashboard - main entry
    location / {
        proxy_pass http://dashboard;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }

    location /dashboard/ {
        proxy_pass http://dashboard/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
    location = /dashboard {
        return 301 /dashboard/;
    }

    # Ergebnis entry (via IP logging -> redirects to n8n form)
    location /ergebnis/ {
        proxy_pass http://ip-logging/;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location = /ergebnis {
        return 301 /ergebnis/;
    }

    # Admin: Edit results
    location /edit-ergebnis/ {
        proxy_pass http://edit-data/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    location = /edit-ergebnis {
        return 301 /edit-ergebnis/;
    }

    # n8n webhooks and forms
    location /form/ {
        proxy_pass http://n8n;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /webhook/ {
        proxy_pass http://n8n;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Success pages
    location /success-event/ {
        proxy_pass http://success-event/;
        proxy_set_header Host $host;
    }
    location = /success-event {
        return 301 /success-event/;
    }

    location /success-emoji/ {
        proxy_pass http://success-emoji/;
        proxy_set_header Host $host;
    }
    location = /success-emoji {
        return 301 /success-emoji/;
    }
}
